FROM ubuntu:22.04

# Installer OpenVPN et dépendances
RUN apt-get update && apt-get install -y \
    openvpn \
    openssl \
    iproute2 \
    easy-rsa \
    strace \
    && rm -rf /var/lib/apt/lists/*

# Créer les répertoires nécessaires
RUN mkdir -p /etc/openvpn/certs /var/log/openvpn /opt/easyrsa

# Copier le script de génération des certificats
COPY generate_certs.sh /opt/generate_certs.sh
RUN chmod +x /opt/generate_certs.sh && /opt/generate_certs.sh

# Permissions
RUN chmod 600 /etc/openvpn/certs/server.key /etc/openvpn/certs/ca.key /etc/openvpn/certs/ta.key 2>/dev/null || true

# Copier la config du serveur
COPY server.conf /etc/openvpn/server.conf

# Copier le script entrypoint
COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Exposer le port
EXPOSE 1194/udp

# Lancer OpenVPN
ENTRYPOINT ["/entrypoint.sh"]

