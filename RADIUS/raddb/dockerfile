FROM ubuntu:22.04

# Installer FreeRADIUS et PostgreSQL driver
RUN apt-get update && apt-get install -y \
    freeradius \
    freeradius-postgresql \
    postgresql-client \
    && rm -rf /var/lib/apt/lists/*

# Créer les répertoires s'ils n'existent pas
RUN mkdir -p /var/lib/freeradius /var/log/freeradius

# Copier les configurations
COPY clients.conf /etc/freeradius/3.0/clients.conf
COPY sql.conf /etc/freeradius/3.0/mods-available/sql
COPY default-site.conf /etc/freeradius/3.0/sites-available/default

# Activer le module SQL
RUN ln -sf /etc/freeradius/3.0/mods-available/sql /etc/freeradius/3.0/mods-enabled/sql 2>/dev/null || true

# Activer le site default (remplacer l'existant)
RUN rm -f /etc/freeradius/3.0/sites-enabled/default && \
    ln -sf /etc/freeradius/3.0/sites-available/default /etc/freeradius/3.0/sites-enabled/default

# Créer les permissions
RUN chown -R freerad:freerad /etc/freeradius /var/lib/freeradius /var/log/freeradius

# Exposer les ports RADIUS
EXPOSE 1812/udp 1813/udp

# Lancer FreeRADIUS en mode debug au démarrage
CMD ["/usr/sbin/freeradius", "-X"]

