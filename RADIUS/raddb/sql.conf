# Configuration SQL pour FreeRADIUS
sql {
    driver = "rlm_sql_postgresql"
    
    # Connexion à PostgreSQL via le nom DNS du conteneur
    dialect = "postgresql"
    
    # Paramètres de connexion
    server = "postgres_radius"
    port = 5432
    login = "radius"
    password = "radpass"
    radius_db = "radius"
    
    # Utiliser User-Name comme identifiant pour les requêtes SQL
    sql_user_name = "%{User-Name}"
    
    # Pool de connexions
    pool {
        start = 5
        min = 3
        max = 10
        spare = 3
        uses = 0
        lifetime = 600
        cleanup_interval = 30
        idle_timeout = 60
        retry_delay = 1
    }
    
    # Requêtes SQL
    
    # Authentification
    authorize_check_query = "SELECT id, username, attribute, value, op FROM radcheck WHERE username = '%{SQL-User-Name}' ORDER BY id"
    authorize_reply_query = "SELECT id, username, attribute, value, op FROM radreply WHERE username = '%{SQL-User-Name}' ORDER BY id"
    
    # Groupes
    authorize_group_check_query = "SELECT id, groupname, attribute, value, op FROM radgroupcheck WHERE groupname IN (SELECT groupname FROM radusergroup WHERE username = '%{SQL-User-Name}') ORDER BY id"
    authorize_group_reply_query = "SELECT id, groupname, attribute, value, op FROM radgroupreply WHERE groupname IN (SELECT groupname FROM radusergroup WHERE username = '%{SQL-User-Name}') ORDER BY id"
    
    # Accounting
    accounting_onoff_query = "UPDATE radacct SET acctstoptime = NOW() WHERE acctsessionid = '%{Acct-Session-Id}' AND username = '%{SQL-User-Name}' AND acctstoptime IS NULL"
    
    accounting_update_query = "UPDATE radacct SET framedipaddress = '%{Framed-IP-Address}', acctsessiontime = '%{Acct-Session-Time}', acctinputoctets = '%{Acct-Input-Octets}', acctoutputoctets = '%{Acct-Output-Octets}' WHERE acctsessionid = '%{Acct-Session-Id}' AND username = '%{SQL-User-Name}' AND acctstoptime IS NULL"
    
    accounting_start_query = "INSERT INTO radacct (acctsessionid, acctuniqueid, username, realm, nasipaddress, acctstarttime, acctsessiontime, acctauthentic) VALUES ('%{Acct-Session-Id}', '%{Acct-Unique-Session-Id}', '%{SQL-User-Name}', '%{Realm}', '%{NAS-IP-Address}', NOW(), '0', '%{Acct-Authentic}')"
    
    accounting_stop_query = "UPDATE radacct SET acctstoptime = NOW(), acctsessiontime = '%{Acct-Session-Time}', acctinputoctets = '%{Acct-Input-Octets}', acctoutputoctets = '%{Acct-Output-Octets}', acctterminatecause = '%{Acct-Terminate-Cause}' WHERE acctsessionid = '%{Acct-Session-Id}' AND username = '%{SQL-User-Name}' AND acctstoptime IS NULL"
}
